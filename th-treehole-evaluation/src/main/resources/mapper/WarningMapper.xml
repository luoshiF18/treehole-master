<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.treehole.evaluation.dao.WarningMapper">

    <delete id="deleteMoreWarning" parameterType="map">
        DELETE FROM
        warning
        WHERE
        warning.id IN
        <foreach collection="list" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>
    <select id="findScaleWarning" resultType="com.treehole.framework.domain.evaluation.vo.WarningVo">
        select
        warning.id,
        scaleName,
        warning.user_id as userId,
        scale_id as scaleId,
        warning_level as warningLevel,
        w_message as Wmessage,
        warning.create_time as createTime
        from warning
        inner join test_scale on warning.scale_id=test_scale.id
    </select>
    <select id="getWaning" parameterType="com.treehole.framework.domain.evaluation.request.WarnRequest" resultType="com.treehole.framework.domain.evaluation.vo.WarningVo">
        select
        warning.id,
        test_scale.scaleName,
        warning.status,
        warning.user_id as userId,
        warning_level as warningLevel,
        w_message as wMessage,
        create_time as createTime
        from warning
        left join test_scale   on warning.scale_id=test_scale.id
        where
        1=1
        <if test="request.startTime!= null and request.endTime != null and
          request.startTime!='' and  request.endTime !=''">
            and
            create_time BETWEEN #{request.startTime} and #{request.endTime}

        </if>
        <if test="request.scaleName != null and request.scaleName !=''">
            AND
            test_scale.scaleName =#{request.scaleName}
        </if>
        <if test="request.userId!=null and request.userId!=''">
            AND
            warning.user_id=#{request.userId}
        </if>
        <if test="request.warningLevel!=null or request.warningLevel==0">
            AND
            warning.warning_level=#{request.warningLevel}
        </if>

    </select>

<select id="getPieData" parameterType="java.lang.String" resultType="com.treehole.framework.domain.evaluation.request.PieData">
                    select
                    COUNT(*)
                    as value,
                    t.scaleType as name
                    from (
                        select
                        test_scale.scaleName,
                        test_scale.typeId,
                        scale_type.scaleType
                        from warning
                        left join test_scale  on warning.scale_id=test_scale.id
                        left join scale_type on test_scale.typeId=scale_type.id
                        where
                        warning.user_id=#{uid}
                    ) t
                    group by
                    t.scaleType
</select>

    <select id="getPieScaData" parameterType="java.lang.String" resultType="com.treehole.framework.domain.evaluation.request.PieData">
                                   select
								        a.value,
										SUBSTRING(a.name,6,1) as name
										from(
										select
                                        count(*)
                                        as value,
                                        t.warningInfo as name
                                        from
                                        (
                                        select
                                        r.warningInfo,
                                        r.createTime,
                                        r.scaleName
                                        from
                                        result r
                                        where

                                        r.scaleName = #{scaleName}
                                        ) t
                                        group by
                                        t.warningInfo
					                    )  a
    </select>

    <select id="getUserPieData" parameterType="java.lang.String" resultType="com.treehole.framework.domain.evaluation.request.PieData">
                    select
                    count(*) as value,
                    resu.typeName as name
                    from(
                    select
                    r.scaleName,
                    r.warningInfo,
                    t.id as typeId,
                    t.scaleType as typeName
                    from result r
                    left join  test_scale s on r.scaleName=s.scaleName
                    left join  scale_type t on s.typeId=t.id
                    where
                    r.userId =#{uid}
                    ) resu
                    group by
                    resu.typeId
    </select>
<select id="findHighRisk"  resultType="com.treehole.framework.domain.evaluation.vo.WarnHUserVo">
                select
                w.warning_level as warningLevel,
                w.w_message as wMessage,
                w.user_id as userId,
                wi.id as warnHUserid,
                wi.way,
                wi.reason,
                wi.status
                from
                warning w
                left join warning_intervene wi on w.id=wi.warning_id
                where
                w.warning_level &gt;= 4
                AND 1=1
                AND
                wi.status<![CDATA[!= ]]>0
                <if test="userNickName!=null and userNickName!=''">
                AND
                wi.user_name=#{userNickName}
                </if>
                <if test="userIds!=null">
                  AND w.user_id IN
                    <foreach collection="userIds" item="userIds" index="index" open="(" separator="," close=")">
                        #{userIds[${index}],jdbcType=VARCHAR}
                    </foreach>
                </if>
                group by
                w.user_id
</select>
<select id="warnHDetail" parameterType="java.lang.String" resultType="com.treehole.framework.domain.evaluation.vo.WarnHUserVo"
>
                select
                w.warning_level as warningLevel,
                w.w_message as wMessage,
                w.create_time as createTime,
                wi.way,
                wi.context,
                wi.reason,
                wi.effect,
                wi.record_time as  recordTime,
                s.scaleName
                from
                warning w
                left join warning_intervene wi on w.id=wi.warning_id
                left join test_scale s on w.scale_id=s.id
                where
                wi.id=#{warnHUserid}
</select>

    <select id="findWarnByUserId" parameterType="java.lang.String" resultType="com.treehole.framework.domain.evaluation.vo.WarningVo">
                select
                s.scaleName,
                w.id,
                w.warning_level as warningLevel,
                w.w_message as wMessage,
                w.create_time as createTime,
                w.user_id as userId
                from
                warning w
                left join test_scale s on w.scale_id=s.id
                WHERE
                w.id IN
               <foreach collection="list" item="warningId" index="index" open="(" separator="," close=")">
                   #{warningId}
             </foreach>

    </select>
    <select id="fingAllByPsy" resultType="com.treehole.framework.domain.evaluation.vo.WarningVo">

    select
    w.id,
	w.status,
	w.warning_level as warningLevel,
	w.w_message as wMessage,
	w.create_time as createTime,
	s.scaleName as scaleName,
	s.topicDescription as description,
	s.topicBackground as background,
	i.way,
	i.user_name as userName,
	i.context,
	i.reason,
	i.effect,
	i.status,
	i.record_time
	from warning w
	left join test_scale s on w.scale_id=s.id
	left join warning_intervene i on w.id=i.warning_id
    where
    w.user_id=#{userId}
    </select>
</mapper>






