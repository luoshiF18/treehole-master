<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.treehole.train.dao.LeaveMapper">

    <!--请假信息统计(请假中的人员信息统计)-->
    <select id="findLeaveByFuzzyQuery"
            resultType="com.treehole.framework.domain.train.Leave"
            parameterType="com.treehole.framework.domain.train.Leave">
            SELECT *
            FROM leaves l
            <where>
                and  l.`leave_state` = '2'
                <if test=" leavePeopleId != null and leavePeopleId != '' ">
                    AND  l.`leave_people_id` =#{leavePeopleId}
                </if>
                <if test=" leavePeopleName != null and leavePeopleName != '' ">
                    AND l.`leave_people_name` LIKE '%${leavePeopleName}%'
                </if>
                <if test=" leavePeopleType != null and leavePeopleType != '' ">
                    AND l.`leave_people_type` =#{leavePeopleType}
                </if>
            </where>
    </select>

    <!--请假信息统计(所有人员信息统计)-->
    <select id="findLeaveAll"
            resultType="com.treehole.framework.domain.train.ext.StudentLeaveExamine"
            parameterType="com.treehole.framework.domain.train.ext.StudentLeaveExamine">
        SELECT
        l.*,
        p.phase_id,
        c.class_name
        FROM leaves l
        LEFT JOIN student s
        ON l.`leave_people_id` = s.student_id
        LEFT JOIN class c
        ON s.`student_class` = c.`class_id`
        LEFT JOIN phase p
        ON p.`phase_id` = c.`class_phase`
        <where>
            <if test=" classId != null and classId != '' ">
                AND l.`leave_people_id` IN
                (
                    SELECT s.student_id
                    FROM student s
                    WHERE s.student_class = #{classId}
                )
            </if>

            <if test=" className != null and className != '' ">
                AND  c.`class_name` LIKE '%${className}%'
            </if>

            <if test=" phaseId != null and phaseId != '' ">
                AND  p.`phase_id` = #{phaseId}
            </if>

            <if test=" leaveState != null and leaveState != '' ">
                AND  l.`leave_state` =#{leaveState}
            </if>
            <if test=" leavePeopleId != null and leavePeopleId != '' ">
                AND  l.`leave_people_id` =#{leavePeopleId}
            </if>
            <if test=" leavePeopleName != null and leavePeopleName != '' ">
                AND l.`leave_people_name` LIKE '%${leavePeopleName}%'
            </if>
            <if test=" leavePeopleType != null and leavePeopleType != '' ">
                AND l.`leave_people_type` =#{leavePeopleType}
            </if>
        </where>
    </select>

    <!--班级需要审核(学生)请假信息统计-->
    <select id="findLeaveStudentExamine"
            resultType="com.treehole.framework.domain.train.Leave"
            parameterType="com.treehole.framework.domain.train.ext.StudentLeaveExamine">
        SELECT *
        FROM leaves l
        <where>
            AND l.`leave_state` = #{leaveState}
            AND l.`leave_people_id` IN
            (
            SELECT s.student_id
            FROM student s
            WHERE s.student_class = #{classId}
            )
            <if test=" leavePeopleId != null and leavePeopleId != '' ">
                AND  l.`leave_people_id` =#{leavePeopleId}
            </if>
            <if test=" leavePeopleName != null and leavePeopleName != '' ">
                AND l.`leave_people_name` LIKE '%${leavePeopleName}%'
            </if>
        </where>
    </select>

    <!--管理员需要审核(老师)请假信息统计-->
    <select id="findLeaveTeacherExamine"
            resultType="com.treehole.framework.domain.train.Leave"
            parameterType="com.treehole.framework.domain.train.Leave"
    >
        SELECT *
        FROM leaves l
        <where>
            AND l.`leave_state` = '3'
            AND l.`leave_people_type` = '2'
            <if test=" leavePeopleId != null and leavePeopleId != '' ">
                AND  l.`leave_people_id` =#{leavePeopleId}
            </if>
            <if test=" leavePeopleName != null and leavePeopleName != '' ">
                AND l.`leave_people_name` LIKE '%${leavePeopleName}%'
            </if>
        </where>
    </select>


    <!--统计个人最后一次请假的记录-->
    <select id="findLastLeaveExamine"
            resultType="com.treehole.framework.domain.train.Leave"
            parameterType="java.lang.String">
        SELECT *
        FROM leaves l
        <where>
            and l.`leave_people_id` = #{id}
            and l.leave_state in(3,4)
            and l.`leave_time` = (SELECT MAX(leave_time) FROM  leaves )
        </where>
    </select>
</mapper>