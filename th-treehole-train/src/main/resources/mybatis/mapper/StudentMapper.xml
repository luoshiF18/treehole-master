<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.treehole.train.dao.StudentMapper">

    <!--查询所有学生-->
    <select id="findAllStudent"
            resultType="com.treehole.framework.domain.train.Student">
       select * from student
    </select>

    <!--模糊查询生-->
    <select id="findStudentByFuzzyQuery"
            parameterType="com.treehole.framework.domain.train.Student"
            resultType="com.treehole.framework.domain.train.ext.StudentExt">
        SELECT
        s.*,
        c.`class_name`,
        p.phase_name
        FROM student s
        LEFT JOIN class c
        ON s.`student_class`= c.`class_id`
        LEFT JOIN phase p
        ON s.student_phase = p.phase_id
        <where>
            <if test=" studentId !=null and studentId !='' "  >
                AND s.`student_id`=#{studentId}
            </if>
            <if test=" studentName !=null and studentName !='' ">
                 AND s.`student_name` like '%${studentName}%'
            </if>
            <if test=" studentGender !=null and studentGender !='' ">
                 AND s.`student_gender`=#{studentGender}
            </if>
            <if test=" studentState !=null and studentState !='' ">
                AND s.`student_state`=#{studentState}
            </if>
            <if test=" studentClass !=null and studentClass !='' ">
                AND s.`student_class`=#{studentClass}
            </if>
            <if test=" studentPhase !=null and studentPhase !='' ">
                AND s.`student_phase`=#{studentPhase}
            </if>
            <if test=" studentGraduation !=null and studentGraduation !='' ">
                AND s.`student_graduation`=#{studentGraduation}
            </if>
            <if test=" studentArrears !=null and studentArrears !='' ">
                AND s.`student_arrears`=#{studentArrears}
            </if>
        </where>
    </select>

    <!--查询学生课程-->
    <select id="findStudentCourse"
            resultType="com.treehole.framework.domain.train.ext.CourseTeacher"
            parameterType="com.treehole.framework.domain.train.ext.StudentCourseParams">

        SELECT *
        FROM (
            SELECT
            co.*,
            t.`teacher_name`,
            tc.`teacher_id`,
            ct.`course_type_name`,
            cc.class_course_id
            FROM student s
            LEFT JOIN class_course cc
            ON  cc.`class_id` = s.student_class
            LEFT JOIN teacher_course tc
            ON cc.`class_course_id` = tc.`class_course_id`
            LEFT JOIN teacher t
            ON tc.`teacher_id` = t.`teacher_id`
            LEFT JOIN course co
            ON cc.`course_id` = co.`course_id`
            LEFT JOIN course_type ct
            ON co.`course_type` = ct.`course_type_id`
            WHERE s.`student_id` = #{studentId}
            AND tc.`state` = 1
            UNION
            SELECT
            co.*,
            t.`teacher_name`,
            tc.`teacher_id`,
            ct.`course_type_name`,
            cc.class_course_id
            FROM student s
            LEFT JOIN class_course cc
            ON  cc.`class_id` = s.student_class
            LEFT JOIN teacher_course tc
            ON cc.`class_course_id` = tc.`class_course_id`
            LEFT JOIN teacher t
            ON tc.`teacher_id` = t.`teacher_id`
            LEFT JOIN course co
            ON cc.`course_id` = co.`course_id`
            LEFT JOIN course_type ct
            ON co.`course_type` = ct.`course_type_id`
            WHERE s.`student_id` = #{studentId}
            AND tc.`state` IS NULL
        ) c
        <where>
            <if test=" courseId !=null and courseId !='' ">
                AND c.`course_id` = #{courseId}
            </if>
            <if test=" courseName !=null and courseName !='' ">
                AND c.`course_name` LIKE '%${courseName}%'
            </if>
            <if test=" courseType !=null and courseType !='' ">
                AND c.`course_type` = #{courseType}
            </if>
            <if test=" courseTeacher !=null and courseTeacher !='' ">
                AND c.`teacher_id` = #{courseTeacher}
            </if>
        </where>

    </select>


    <!--查询学生老师-->
    <select id="findStudentTeacher"
            resultType="com.treehole.framework.domain.train.Teacher"
            parameterType="com.treehole.framework.domain.train.ext.TeacherExt">

        SELECT *
        FROM (
            SELECT t.*
            FROM student s
            LEFT JOIN class c
            on s.student_class = c.class_id
            LEFT JOIN teacher t
            ON c.`class_headmaster` = t.`teacher_id`
            WHERE s.`student_id`= #{studentId}
            UNION
            SELECT t.*
            FROM student s
            LEFT JOIN class_course cc
            ON  cc.`class_id` = s.student_class
            LEFT JOIN teacher_course tc
            ON cc.`class_course_id` = tc.`class_course_id`
            LEFT JOIN teacher t
            ON tc.`teacher_id` = t.`teacher_id`
            WHERE s.student_id = #{studentId}
            AND tc.`state` = 1
        ) te
        <where>
                <if test="teacherId !=null and teacherId !='' ">
                    AND te.`teacher_id` = #{teacherId}
                </if>
                <if test="teacherName !=null and teacherName !='' ">
                    AND te.`teacher_name` LIKE '%${teacherName}%'
                </if>
                <if test=" teacherGender !=null and teacherGender !='' ">
                    AND te.`teacher_gender` = #{teacherGender}
                </if>
                <if test=" teacherState !=null and teacherState !='' ">
                    AND te.`teacher_state` = #{teacherState}
                </if>
                <if test=" teacherType !=null and teacherType !='' ">
                    AND te.`teacher_type` = #{teacherType}
                </if>
        </where>
    </select>

    <!--学生交费记录(欠费记录)-->
    <select id="findPay"
            resultType="com.treehole.framework.domain.train.Cost"
            parameterType="com.treehole.framework.domain.train.Student">
        SELECT c.*
        FROM cost c
        LEFT JOIN student s
        ON c.`cost_student_id` = s.`student_id`
        LEFT JOIN class cl
        ON s.`student_class`= cl.`class_id`
        LEFT JOIN phase p
        ON cl.`class_phase` = p.phase_id
        <where>
<!--            <if test=" costStudentId !=null and costStudentId !='' ">-->
<!--                AND c.`cost_student_id`= #{costStudentId}-->
<!--            </if>-->
<!--            <if test=" costStudentName !=null and costStudentName !=''  ">-->
<!--                AND c.`cost_student_name` LIKE '%${costStudentName}%'-->
<!--            </if>-->

            <if test=" studentId !=null and studentId !='' "  >
                AND s.`student_id`=#{studentId}
            </if>
            <if test=" studentName !=null and studentName !='' ">
                AND s.`student_name` like '%${studentName}%'
            </if>

            <if test=" studentGender !=null and studentGender !='' ">
                AND s.`student_gender`=#{studentGender}
            </if>
            <if test=" studentState !=null and studentState !='' ">
                AND s.`student_state`=#{studentState}
            </if>
            <if test=" studentClass !=null and studentClass !='' ">
                AND s.`student_class`=#{studentClass}
            </if>
            <if test=" studentPhase !=null and studentPhase !='' ">
                AND s.`student_phase`=#{studentPhase}
            </if>
            <if test=" studentGraduation !=null and studentGraduation !='' ">
                AND s.`student_graduation`=#{studentGraduation}
            </if>
            <if test=" studentArrears !=null and studentArrears !='' ">
                AND s.`student_arrears`=#{studentArrears}
            </if>
        </where>
        ORDER BY
        s.`student_id` ASC,
	    c.`cost_time` ASC

    </select>

</mapper>